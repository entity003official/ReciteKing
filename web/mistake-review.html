<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”™é¢˜é‡åš - å‡åèƒŒè¯µç‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .nav-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            margin: -20px -20px 2rem -20px;
            padding: 1rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 16px 16px;
        }
        .nav-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-header h1 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .nav-links {
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.3rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .nav-links a {
            padding: 0.6rem 1rem;
            text-decoration: none;
            color: white;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .nav-links a.active {
            background: linear-gradient(45deg, #ffd93d, #ff6b6b);
            color: #333;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        .filter-select, .filter-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        .mistake-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .mistake-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        .mistake-item:hover {
            background: #f8f9fa;
        }
        .mistake-item:last-child {
            border-bottom: none;
        }
        .mistake-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }
        .mistake-info {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 100px 80px;
            gap: 15px;
            align-items: center;
        }
        .mistake-kana {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        .mistake-kanji {
            color: #666;
        }
        .mistake-meaning {
            color: #888;
        }
        .mistake-count {
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .mistake-date {
            font-size: 0.85rem;
            color: #aaa;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }
        .hidden { display: none; }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .nav-content { flex-direction: column; gap: 10px; }
            .mistake-info {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <nav class="nav-header">
                <div class="nav-content">
                    <h1>ğŸ”„ é”™é¢˜é‡åš</h1>
                    <div class="nav-links">
                        <a href="index.html">ğŸ  é¦–é¡µ</a>
                        <a href="word-typing.html">âœï¸ å•è¯è¾“å…¥</a>
                        <a href="curriculum-selection.html">ğŸ“š è¯¾ç¨‹ç»ƒä¹ </a>
                        <a href="curriculum-stats.html">ğŸ“Š è¯¾ç¨‹ç»Ÿè®¡</a>
                        <a href="mistake-review.html" class="active">ğŸ”„ é”™é¢˜é‡åš</a>
                        <a href="data-manager.html">ğŸ”§ æ•°æ®ç®¡ç†</a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="card">
            <h3>ğŸ“Š é”™é¢˜ç»Ÿè®¡æ¦‚è§ˆ</h3>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMistakes">-</div>
                    <div class="stat-label">é”™é¢˜æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalErrors">-</div>
                    <div class="stat-label">ç´¯è®¡é”™è¯¯æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayErrors">-</div>
                    <div class="stat-label">ä»Šæ—¥é”™é¢˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="yesterdayErrors">-</div>
                    <div class="stat-label">æ˜¨æ—¥é”™é¢˜</div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰å’Œæ§åˆ¶ -->
        <div class="card">
            <h3>ğŸ” ç­›é€‰é”™é¢˜</h3>
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">æŒ‰æ—¥æœŸç­›é€‰</label>
                        <select class="filter-select" id="dateFilter">
                            <option value="all">æ‰€æœ‰é”™é¢˜</option>
                            <option value="today">ä»Šå¤©çš„é”™é¢˜</option>
                            <option value="yesterday">æ˜¨å¤©çš„é”™é¢˜</option>
                            <option value="custom">è‡ªå®šä¹‰æ—¥æœŸ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">è‡ªå®šä¹‰æ—¥æœŸ</label>
                        <input type="date" class="filter-input" id="customDate" disabled>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">é”™è¯¯æ¬¡æ•°ç­›é€‰</label>
                        <select class="filter-select" id="errorCountFilter">
                            <option value="all">æ‰€æœ‰é”™è¯¯æ¬¡æ•°</option>
                            <option value="1">1æ¬¡é”™è¯¯</option>
                            <option value="2-3">2-3æ¬¡é”™è¯¯</option>
                            <option value="4-5">4-5æ¬¡é”™è¯¯</option>
                            <option value="6+">6æ¬¡ä»¥ä¸Šé”™è¯¯</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">æ˜¾ç¤ºæ•°é‡</label>
                        <select class="filter-select" id="limitFilter">
                            <option value="50">æ˜¾ç¤º50ä¸ª</option>
                            <option value="100">æ˜¾ç¤º100ä¸ª</option>
                            <option value="200">æ˜¾ç¤º200ä¸ª</option>
                            <option value="all">æ˜¾ç¤ºå…¨éƒ¨</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="applyFilters()">ğŸ” åº”ç”¨ç­›é€‰</button>
                <button class="btn btn-secondary" onclick="selectAllMistakes()">âœ… å…¨é€‰</button>
                <button class="btn btn-secondary" onclick="deselectAllMistakes()">âŒ å…¨ä¸é€‰</button>
                <button class="btn btn-success" onclick="startMistakeReview()" id="startReviewBtn" disabled>ğŸš€ å¼€å§‹é‡åš</button>
                <button class="btn btn-warning" onclick="downloadMistakeCSV()">ğŸ“¥ ä¸‹è½½CSV</button>
            </div>
        </div>

        <!-- é”™é¢˜åˆ—è¡¨ -->
        <div class="card">
            <h3>ğŸ“ é”™é¢˜åˆ—è¡¨ <span id="selectedMistakeCount">(å·²é€‰æ‹©: 0)</span></h3>
            <div id="mistakeListContainer">
                <div class="empty-state">
                    <h3>ğŸ” æ­£åœ¨åŠ è½½é”™é¢˜æ•°æ®...</h3>
                    <p>è¯·ç¨å€™</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="vocabulary-manager.js"></script>
    <script src="mistake-tracker.js"></script>
    <script>
        class MistakeReview {
            constructor() {
                this.filteredMistakes = [];
                this.selectedMistakes = new Set();
                this.init();
            }

            async init() {
                console.log('é”™é¢˜é‡åšé¡µé¢åˆå§‹åŒ–...');
                
                // ç­‰å¾…é”™é¢˜è·Ÿè¸ªå™¨åˆå§‹åŒ–
                if (window.mistakeTracker) {
                    this.loadStatistics();
                    this.loadMistakeList();
                    this.setupEventListeners();
                } else {
                    console.error('é”™é¢˜è·Ÿè¸ªå™¨æœªæ‰¾åˆ°');
                }
            }

            loadStatistics() {
                const stats = window.mistakeTracker.getStatistics();
                
                document.getElementById('totalMistakes').textContent = stats.totalMistakes;
                document.getElementById('totalErrors').textContent = stats.totalErrors;
                document.getElementById('todayErrors').textContent = stats.todayErrors;
                document.getElementById('yesterdayErrors').textContent = stats.yesterdayErrors;
            }

            loadMistakeList() {
                this.applyFilters();
            }

            setupEventListeners() {
                // æ—¥æœŸç­›é€‰å˜åŒ–
                document.getElementById('dateFilter').addEventListener('change', (e) => {
                    const customDate = document.getElementById('customDate');
                    customDate.disabled = e.target.value !== 'custom';
                    if (e.target.value === 'custom') {
                        customDate.value = new Date().toISOString().split('T')[0];
                    }
                });

                // è‡ªå®šä¹‰æ—¥æœŸå˜åŒ–
                document.getElementById('customDate').addEventListener('change', () => {
                    if (document.getElementById('dateFilter').value === 'custom') {
                        this.applyFilters();
                    }
                });
            }

            applyFilters() {
                const dateFilter = document.getElementById('dateFilter').value;
                const customDate = document.getElementById('customDate').value;
                const errorCountFilter = document.getElementById('errorCountFilter').value;
                const limitFilter = document.getElementById('limitFilter').value;

                // è·å–åŸºç¡€é”™é¢˜æ•°æ®
                let mistakes = [];
                
                switch (dateFilter) {
                    case 'today':
                        mistakes = window.mistakeTracker.getTodaysMistakes();
                        break;
                    case 'yesterday':
                        mistakes = window.mistakeTracker.getYesterdaysMistakes();
                        break;
                    case 'custom':
                        if (customDate) {
                            mistakes = window.mistakeTracker.getMistakesByDate(customDate);
                        }
                        break;
                    default:
                        mistakes = window.mistakeTracker.getMostMistakenWords(1000);
                }

                // æŒ‰é”™è¯¯æ¬¡æ•°ç­›é€‰
                if (errorCountFilter !== 'all') {
                    mistakes = mistakes.filter(word => {
                        const count = word.mistakeCount;
                        switch (errorCountFilter) {
                            case '1': return count === 1;
                            case '2-3': return count >= 2 && count <= 3;
                            case '4-5': return count >= 4 && count <= 5;
                            case '6+': return count >= 6;
                            default: return true;
                        }
                    });
                }

                // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                if (limitFilter !== 'all') {
                    const limit = parseInt(limitFilter);
                    mistakes = mistakes.slice(0, limit);
                }

                this.filteredMistakes = mistakes;
                this.renderMistakeList();
            }

            renderMistakeList() {
                const container = document.getElementById('mistakeListContainer');
                
                if (this.filteredMistakes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>ğŸ˜Š æ²¡æœ‰æ‰¾åˆ°é”™é¢˜</h3>
                            <p>æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶æ²¡æœ‰æ‰¾åˆ°é”™é¢˜ï¼Œç»§ç»­åŠ æ²¹ï¼</p>
                        </div>
                    `;
                    return;
                }

                const listHtml = `
                    <div class="mistake-list">
                        ${this.filteredMistakes.map((word, index) => `
                            <div class="mistake-item">
                                <input type="checkbox" class="mistake-checkbox" 
                                       data-word-id="${word.wordId}" 
                                       onchange="mistakeReview.toggleMistakeSelection('${word.wordId}')">
                                <div class="mistake-info">
                                    <div class="mistake-kana">${word.kana || 'æ— å‡å'}</div>
                                    <div class="mistake-kanji">${word.kanji || 'æ— æ±‰å­—'}</div>
                                    <div class="mistake-meaning">${word.meaning || 'æ— é‡Šä¹‰'}</div>
                                    <div class="mistake-count">${word.mistakeCount}æ¬¡</div>
                                    <div class="mistake-date">${this.formatDates(word.mistakeDates)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.innerHTML = listHtml;
                this.updateSelectedCount();
            }

            formatDates(dates) {
                if (!dates || dates.length === 0) return '';
                const latest = dates[dates.length - 1];
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                
                if (latest === today) return 'ä»Šå¤©';
                if (latest === yesterday) return 'æ˜¨å¤©';
                return latest;
            }

            toggleMistakeSelection(wordId) {
                if (this.selectedMistakes.has(wordId)) {
                    this.selectedMistakes.delete(wordId);
                } else {
                    this.selectedMistakes.add(wordId);
                }
                this.updateSelectedCount();
                this.updateStartButton();
            }

            updateSelectedCount() {
                const count = this.selectedMistakes.size;
                document.getElementById('selectedMistakeCount').textContent = `(å·²é€‰æ‹©: ${count})`;
            }

            updateStartButton() {
                const btn = document.getElementById('startReviewBtn');
                btn.disabled = this.selectedMistakes.size === 0;
            }

            selectAllMistakes() {
                this.selectedMistakes.clear();
                this.filteredMistakes.forEach(word => {
                    this.selectedMistakes.add(word.wordId);
                });
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                document.querySelectorAll('.mistake-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                this.updateSelectedCount();
                this.updateStartButton();
            }

            deselectAllMistakes() {
                this.selectedMistakes.clear();
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                document.querySelectorAll('.mistake-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                this.updateSelectedCount();
                this.updateStartButton();
            }

            startMistakeReview() {
                if (this.selectedMistakes.size === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦é‡åšçš„é”™é¢˜ï¼');
                    return;
                }

                // è·å–é€‰ä¸­çš„é”™é¢˜å•è¯
                const selectedWords = this.filteredMistakes.filter(word => 
                    this.selectedMistakes.has(word.wordId)
                );

                // è½¬æ¢ä¸ºç»ƒä¹ æ ¼å¼
                const wordsForPractice = selectedWords.map(word => ({
                    ...word,
                    repeatCount: 1 // é”™é¢˜é‡åšæ¯ä¸ªå•è¯ç»ƒä¹ 1æ¬¡
                }));

                // ä¿å­˜åˆ°sessionStorage
                sessionStorage.setItem('selectedWords', JSON.stringify(wordsForPractice));
                sessionStorage.setItem('practiceMode', 'mistake-review');

                // è·³è½¬åˆ°ç»ƒä¹ é¡µé¢
                window.location.href = 'word-practice.html';
            }

            downloadMistakeCSV() {
                if (window.mistakeTracker) {
                    window.mistakeTracker.downloadMistakeCSV();
                } else {
                    alert('é”™é¢˜è·Ÿè¸ªå™¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¸‹è½½CSVæ–‡ä»¶');
                }
            }
        }

        // å…¨å±€å‡½æ•°
        window.applyFilters = () => mistakeReview.applyFilters();
        window.selectAllMistakes = () => mistakeReview.selectAllMistakes();
        window.deselectAllMistakes = () => mistakeReview.deselectAllMistakes();
        window.startMistakeReview = () => mistakeReview.startMistakeReview();
        window.downloadMistakeCSV = () => mistakeReview.downloadMistakeCSV();

        // åˆå§‹åŒ–
        const mistakeReview = new MistakeReview();
    </script>
</body>
</html>
