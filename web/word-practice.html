<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯ç»ƒä¹  - å‡åèƒŒè¯µç‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: #ffd93d;
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }
        .question-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .question-meaning {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }
        .question-info {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        .repeat-info {
            background: #e7f3ff;
            color: #0066cc;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
            border: 2px solid #b8daff;
        }
        .repeat-info.completed {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .answer-input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            font-size: 1.5rem;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }
        .answer-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }
        .answer-input.correct {
            border-color: #28a745;
            background: #d4edda;
        }
        .answer-input.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        /* æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        .correct-answer-display {
            margin: 15px 0;
            padding: 15px 20px;
            background: #ffe6e6;
            border: 2px solid #ff9999;
            border-radius: 8px;
            text-align: center;
            animation: fadeIn 0.3s ease-in;
        }
        
        .correct-answer-label {
            font-size: 1rem;
            color: #cc0000;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .correct-answer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .correct-answer-kana {
            font-size: 2rem;
            color: #990000;
            font-weight: 700;
            font-family: 'Arial', sans-serif;
            line-height: 1.2;
        }
        
        .correct-answer-kanji {
            font-size: 1.6rem;
            color: #666666;
            font-weight: 600;
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            line-height: 1.2;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* è™šæ‹Ÿé”®ç›˜æ ·å¼ */
        .virtual-keyboard {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .keyboard-title {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
        }
        
        .keyboard-switch {
            padding: 8px 16px;
            background: #e7f3ff;
            color: #0066cc;
            border: 2px solid #b8daff;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .keyboard-switch:hover {
            background: #cce7ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .keyboard-layout {
            margin-bottom: 15px;
        }
        
        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .key-btn {
            min-width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .key-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .key-btn:active {
            transform: translateY(0);
            background: #dee2e6;
        }
        
        .key-special {
            background: #6c757d;
            color: white;
            min-width: 60px;
        }
        
        .key-special:hover {
            background: #545b62;
        }
        
        .kana-candidates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
            min-height: 50px;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .kana-option {
            padding: 8px 16px;
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 60px;
        }
        
        .kana-option:hover {
            background: #cce7ff;
            transform: translateY(-1px);
        }
        
        .kana-option.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        .kana-option.selected .kana-romaji {
            color: #e3f2fd;
        }
        
        .kana-option.selected .kana-text {
            color: white;
        }
        
        .kana-romaji {
            font-size: 0.8rem;
            color: #6c757d;
            display: block;
        }
        
        .kana-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            display: block;
        }
        
        .current-input {
            text-align: center;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .input-label {
            color: #6c757d;
            margin-right: 8px;
        }
        
        .input-romaji {
            font-family: monospace;
            font-weight: 600;
            color: #495057;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        /* å¿«æ·é”®æ ·å¼ */
        kbd {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-family: monospace;
            color: #495057;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .keyboard-instructions {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .keyboard-row {
                gap: 3px;
            }
            
            .key-btn {
                min-width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .key-special {
                min-width: 50px;
            }
            
            .kana-option {
                min-width: 50px;
                padding: 6px 12px;
            }
            
            .kana-text {
                font-size: 1.1rem;
            }
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .result-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .result-title {
            font-size: 2rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 20px;
        }
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .hidden {
            display: none !important;
        }
        
        /* é”™è¯¯æ˜¾ç¤ºæ ·å¼ */
        .error-display {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .error-display.hidden {
            display: none !important;
        }
        
        .error-info {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .error-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 20px;
        }
        
        .error-answer {
            margin: 20px 0;
        }
        
        .your-answer {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1.2rem;
            border-left: 4px solid #dc3545;
        }
        
        .correct-answer {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1.4rem;
            font-weight: bold;
            border-left: 4px solid #28a745;
        }
        
        .kanji-display {
            background: #e2e3e5;
            color: #383d41;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: bold;
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç»ƒä¹ ç•Œé¢ -->
        <div id="practiceScreen">
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 style="margin: 0;">ğŸ¯ å•è¯ç»ƒä¹ </h1>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showPerformancePanel()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">ğŸ“Š æ€§èƒ½</button>
                        <button class="btn btn-secondary" onclick="exitPractice()">é€€å‡ºç»ƒä¹ </button>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <span id="progressText">é¢˜ç›® 1 / 10</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-meaning" id="questionMeaning">æ­£åœ¨åŠ è½½...</div>
                <div class="question-info" id="questionInfo"></div>
                <div class="repeat-info" id="repeatInfo">èƒŒè¯µè¿›åº¦: 1/3</div>
                <input type="text" class="answer-input" id="answerInput" placeholder="è¯·è¾“å…¥ç½—é©¬éŸ³ï¼Œç©ºæ ¼é€‰æ‹©å‡å..." autocomplete="off">
                
                <!-- è™šæ‹Ÿé”®ç›˜ -->
                <div id="virtualKeyboard" class="virtual-keyboard">
                    <!-- æ“ä½œè¯´æ˜ -->
                    <div class="keyboard-instructions">
                        <div style="font-size: 0.9rem; color: #495057; margin-bottom: 10px; text-align: center;">
                            ğŸ’¡ <strong>å¿«æ·é”®ï¼š</strong> 
                            ç›´æ¥è¾“å…¥ç½—é©¬éŸ³ | 
                            <kbd>Tab</kbd> / <kbd>Enter</kbd> é€‰æ‹©å‡å | 
                            <kbd>â†‘</kbd><kbd>â†“</kbd> åˆ‡æ¢å€™é€‰ | 
                            ç‚¹å‡»æŒ‰é’®æäº¤ç­”æ¡ˆ | 
                            <kbd>Esc</kbd> æ¸…ç©ºå½“å‰è¾“å…¥
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d; text-align: center;">
                            ğŸ“ <strong>ä¿ƒéŸ³è¾“å…¥ï¼š</strong> åŒå†™è¾…éŸ³å¯è¾“å…¥ä¿ƒéŸ³ï¼Œå¦‚ kkâ†’ã£k, ttâ†’ã£t, ssâ†’ã£s
                        </div>
                    </div>
                    
                    <div class="keyboard-header">
                        <span class="keyboard-title">è™šæ‹Ÿé”®ç›˜ï¼ˆè¾…åŠ©å·¥å…·ï¼‰</span>
                        <div class="keyboard-toggle">
                            <span style="margin-right: 10px; color: #666; font-size: 0.9rem;">å‡åç±»å‹ï¼š</span>
                            <button class="keyboard-switch" id="kanaTypeSwitch" data-type="hiragana" title="ç‚¹å‡»åˆ‡æ¢å¹³å‡å/ç‰‡å‡å">ã‚ å¹³å‡å</button>
                        </div>
                    </div>
                    
                    <!-- è‹±æ–‡é”®ç›˜å¸ƒå±€ -->
                    <div class="keyboard-layout">
                        <div class="keyboard-row">
                            <button class="key-btn" data-key="q">Q</button>
                            <button class="key-btn" data-key="w">W</button>
                            <button class="key-btn" data-key="e">E</button>
                            <button class="key-btn" data-key="r">R</button>
                            <button class="key-btn" data-key="t">T</button>
                            <button class="key-btn" data-key="y">Y</button>
                            <button class="key-btn" data-key="u">U</button>
                            <button class="key-btn" data-key="i">I</button>
                            <button class="key-btn" data-key="o">O</button>
                            <button class="key-btn" data-key="p">P</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="key-btn" data-key="a">A</button>
                            <button class="key-btn" data-key="s">S</button>
                            <button class="key-btn" data-key="d">D</button>
                            <button class="key-btn" data-key="f">F</button>
                            <button class="key-btn" data-key="g">G</button>
                            <button class="key-btn" data-key="h">H</button>
                            <button class="key-btn" data-key="j">J</button>
                            <button class="key-btn" data-key="k">K</button>
                            <button class="key-btn" data-key="l">L</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="key-btn key-special" data-key="backspace">âŒ«</button>
                            <button class="key-btn" data-key="z">Z</button>
                            <button class="key-btn" data-key="x">X</button>
                            <button class="key-btn" data-key="c">C</button>
                            <button class="key-btn" data-key="v">V</button>
                            <button class="key-btn" data-key="b">B</button>
                            <button class="key-btn" data-key="n">N</button>
                            <button class="key-btn" data-key="m">M</button>
                            <button class="key-btn key-special" data-key="clear">æ¸…ç©º</button>
                        </div>
                    </div>
                    
                    <!-- å‡åå€™é€‰åŒºåŸŸ -->
                    <div class="kana-candidates" id="kanaCandidates"></div>
                    
                    <!-- å½“å‰è¾“å…¥æ˜¾ç¤º -->
                    <div class="current-input" id="currentInput">
                        <span class="input-label">å½“å‰è¾“å…¥ï¼š</span>
                        <span class="input-romaji" id="inputRomaji"></span>
                    </div>
                </div>
                
                <!-- æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="correctAnswerDisplay" class="correct-answer-display hidden">
                    <div class="correct-answer-content">
                        <div class="correct-answer-kana" id="correctAnswerKana"></div>
                        <div class="correct-answer-kanji" id="correctAnswerKanji"></div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" id="submitBtn" onclick="safeCall('checkAnswer')">æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="safeCall('showAnswer')">æˆ‘ä¸ä¼š</button>
                    <button class="btn btn-secondary" onclick="safeCall('skipQuestion')">è·³è¿‡</button>
                </div>
                
                <!-- é”™è¯¯ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="errorDisplay" class="error-display hidden">
                    <div class="error-info">
                        <button onclick="continueToNext()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;" title="å…³é—­">âœ•</button>
                        <div class="error-title">âŒ ç­”é”™äº†</div>
                        <div class="error-answer">
                            <div class="your-answer">æ‚¨çš„ç­”æ¡ˆ: <span id="yourAnswer"></span></div>
                            <div class="correct-answer">æ­£ç¡®ç­”æ¡ˆ: <span id="correctAnswerDisplay"></span></div>
                            <div class="kanji-display">æ±‰å­—å†™æ³•: <span id="kanjiDisplay"></span></div>
                        </div>
                        <div style="margin: 20px 0;">
                            <button class="btn btn-primary" onclick="continueToNext()">ç»§ç»­ä¸‹ä¸€é¢˜</button>
                            <button class="btn btn-secondary" onclick="forceExit()" style="margin-left: 10px;">å¼ºåˆ¶é€€å‡º</button>
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">æŒ‰ Enter æˆ– Escape é”®ç»§ç»­</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç»“æœç•Œé¢ -->
        <div id="resultScreen" class="hidden">
            <div class="result-card">
                <div class="result-title">ğŸ‰ ç»ƒä¹ å®Œæˆï¼</div>
                <div class="result-stats" id="resultStats"></div>
                <div class="buttons">
                    <button class="btn btn-success" onclick="restartPractice()">é‡æ–°ç»ƒä¹ </button>
                    <button class="btn btn-primary" onclick="backToSelection()">è¿”å›é€‰æ‹©</button>
                </div>
            </div>
        </div>
    </div>

    <script src="performance-monitor.js"></script>
    <script src="romaji-converter.js"></script>
    <script>
        // éªŒè¯ç”¨æˆ·è¾“å…¥çš„ç­”æ¡ˆ - æ”¯æŒå¤šä¸ªå¯èƒ½çš„ç­”æ¡ˆï¼ˆç”¨|åˆ†éš”ï¼‰
        function validateAnswer(userInput, correctAnswer) {
            // æ¸…ç†ç”¨æˆ·è¾“å…¥
            const cleanInput = userInput.trim().toLowerCase();
            
            // å¤„ç†å¤šä¸ªå¯èƒ½çš„ç­”æ¡ˆï¼ˆç”¨|åˆ†éš”ï¼‰
            const possibleAnswers = correctAnswer.split('|').map(answer => answer.trim().toLowerCase());
            
            // æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦åŒ¹é…ä»»ä½•ä¸€ä¸ªå¯èƒ½çš„ç­”æ¡ˆ
            return possibleAnswers.includes(cleanInput);
        }
        
        // åŠ è½½é”™é¢˜è·Ÿè¸ªå™¨
        if (!window.mistakeTracker) {
            const script = document.createElement('script');
            script.src = 'mistake-tracker.js';
            script.onload = () => console.log('é”™é¢˜è·Ÿè¸ªå™¨å·²åŠ è½½');
            document.head.appendChild(script);
        }
        
        class WordPractice {
            constructor() {
                this.words = [];
                this.originalWords = []; // ä¿å­˜åŸå§‹å•è¯æ•°æ®ï¼ŒåŒ…å«èƒŒè¯µæ¬¡æ•°
                this.currentIndex = 0;
                this.correctCount = 0;
                this.wrongCount = 0;
                this.skippedCount = 0;
                this.dontKnowCount = 0; // æ”¹ä¸º"æˆ‘ä¸ä¼š"çš„è®¡æ•°
                this.currentAnswer = '';
                this.currentWordData = null; // å½“å‰å•è¯çš„å®Œæ•´æ•°æ®
                
                // è™šæ‹Ÿé”®ç›˜ç›¸å…³
                this.romajiConverter = new RomajiConverter();
                this.currentRomaji = '';
                this.currentKanaType = 'hiragana';
                
                this.init();
            }
            
            init() {
                // å¼ºåˆ¶ç¡®ä¿é”™è¯¯æ˜¾ç¤ºç•Œé¢æ˜¯éšè—çš„
                const errorDisplay = document.getElementById('errorDisplay');
                if (errorDisplay) {
                    errorDisplay.classList.add('hidden');
                    errorDisplay.style.display = 'none';
                    console.log('åœ¨initä¸­å¼ºåˆ¶éšè—é”™è¯¯æ˜¾ç¤ºç•Œé¢');
                }
                
                // ä»sessionStorageè·å–é€‰æ‹©çš„å•è¯
                const savedWords = sessionStorage.getItem('selectedWords');
                if (!savedWords) {
                    alert('æ²¡æœ‰æ‰¾åˆ°é€‰æ‹©çš„å•è¯ï¼Œè¿”å›é€‰æ‹©é¡µé¢');
                    this.backToSelection();
                    return;
                }
                
                this.initKeyboard();
                
                try {
                    this.originalWords = JSON.parse(savedWords);
                    console.log('åŠ è½½çš„åŸå§‹å•è¯æ•°æ®:', this.originalWords);
                    
                    if (this.originalWords.length === 0) {
                        alert('æ²¡æœ‰å¯ç»ƒä¹ çš„å•è¯ï¼Œè¿”å›é€‰æ‹©é¡µé¢');
                        this.backToSelection();
                        return;
                    }
                    
                    // åˆ›å»ºç»ƒä¹ é˜Ÿåˆ—ï¼Œæ¯ä¸ªå•è¯æ ¹æ®å…¶èƒŒè¯µæ¬¡æ•°æ·»åŠ å¤šæ¬¡
                    this.createPracticeQueue();
                    console.log('ç»ƒä¹ é˜Ÿåˆ—åˆ›å»ºå®Œæˆï¼Œé˜Ÿåˆ—é•¿åº¦:', this.words.length);
                    
                    this.showCurrentQuestion();
                    this.bindEvents();
                } catch (error) {
                    console.error('åˆå§‹åŒ–ç»ƒä¹ å¤±è´¥:', error);
                    alert('ç»ƒä¹ æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¿”å›é€‰æ‹©é¡µé¢');
                    this.backToSelection();
                }
            }
            
            // åˆ›å»ºç»ƒä¹ é˜Ÿåˆ—ï¼Œæ ¹æ®èƒŒè¯µæ¬¡æ•°é‡å¤æ·»åŠ å•è¯
            createPracticeQueue() {
                if (window.performanceMonitor) {
                    return window.performanceMonitor.measureOperation('createPracticeQueue', () => {
                        return this._createPracticeQueueInternal();
                    });
                } else {
                    return this._createPracticeQueueInternal();
                }
            }
            
            _createPracticeQueueInternal() {
                this.words = [];
                this.originalWords.forEach((wordData, originalIndex) => {
                    const repeatCount = wordData.repeatCount || 1;
                    for (let i = 0; i < repeatCount; i++) {
                        this.words.push({
                            ...wordData,
                            originalIndex: originalIndex,
                            currentRepeat: i + 1,
                            totalRepeats: repeatCount,
                            remainingRepeats: repeatCount - i
                        });
                    }
                });
                
                // æµ‹è¯•ç®—æ³•å¤æ‚åº¦ï¼ˆä»…åœ¨æ€§èƒ½ç›‘æ§å¯ç”¨æ—¶ï¼‰
                if (window.performanceMonitor) {
                    window.performanceMonitor.analyzeComplexity('wordQueueCreation', this.originalWords.length, (size) => {
                        const testWords = this.originalWords.slice(0, size);
                        const testQueue = [];
                        testWords.forEach((wordData, originalIndex) => {
                            const repeatCount = wordData.repeatCount || 1;
                            for (let i = 0; i < repeatCount; i++) {
                                testQueue.push({...wordData, originalIndex});
                            }
                        });
                    });
                }
                
                // æ‰“ä¹±ç»ƒä¹ é¡ºåº
                this.shuffleArray(this.words);
                console.log('ç»ƒä¹ é˜Ÿåˆ—åˆ›å»ºå®Œæˆï¼Œæ€»é¢˜æ•°:', this.words.length);
            }
            
            // æ‰“ä¹±æ•°ç»„
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            // åˆå§‹åŒ–è™šæ‹Ÿé”®ç›˜
            initKeyboard() {
                // ç»‘å®šé”®ç›˜äº‹ä»¶
                const keyButtons = document.querySelectorAll('.key-btn');
                keyButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const key = e.target.dataset.key;
                        this.handleKeyPress(key);
                    });
                });
                
                // ç»‘å®šå‡åç±»å‹åˆ‡æ¢
                const kanaSwitch = document.getElementById('kanaTypeSwitch');
                kanaSwitch.addEventListener('click', () => {
                    this.toggleKanaType();
                });
                
                // åˆå§‹åŒ–æŒ‰é’®æ ·å¼
                kanaSwitch.textContent = 'ã‚ å¹³å‡å';
                kanaSwitch.style.background = '#e7f3ff';
                kanaSwitch.style.color = '#0066cc';
                
                // åˆå§‹åŒ–å€™é€‰é€‰æ‹©çŠ¶æ€
                this.selectedCandidateIndex = 0;
                
                // åˆå§‹æ›´æ–°æ˜¾ç¤º
                this.updateCandidates();
                this.updateCurrentInput();
            }
            
            // å¤„ç†è™šæ‹Ÿé”®ç›˜æŒ‰é”®
            handleKeyPress(key) {
                const input = document.getElementById('answerInput');
                
                if (key === 'backspace') {
                    if (this.currentRomaji.length > 0) {
                        // åˆ é™¤å½“å‰ç½—é©¬éŸ³çš„æœ€åä¸€ä¸ªå­—ç¬¦
                        this.currentRomaji = this.currentRomaji.slice(0, -1);
                        input.value = input.value.slice(0, -1);
                    } else {
                        // å¦‚æœæ²¡æœ‰ç½—é©¬éŸ³ï¼Œåˆ é™¤è¾“å…¥æ¡†çš„æœ€åä¸€ä¸ªå­—ç¬¦
                        input.value = input.value.slice(0, -1);
                    }
                } else if (key === 'clear') {
                    this.currentRomaji = '';
                    input.value = '';
                } else if (/^[a-zA-Z]$/.test(key)) {
                    this.currentRomaji += key.toLowerCase();
                    input.value += key.toLowerCase();
                }
                
                this.updateCandidates();
                this.updateCurrentInput();
            }
            
            // åˆ‡æ¢å‡åç±»å‹
            toggleKanaType() {
                this.currentKanaType = this.currentKanaType === 'hiragana' ? 'katakana' : 'hiragana';
                const switchBtn = document.getElementById('kanaTypeSwitch');
                if (this.currentKanaType === 'hiragana') {
                    switchBtn.textContent = 'ã‚ å¹³å‡å';
                    switchBtn.style.background = '#e7f3ff';
                    switchBtn.style.color = '#0066cc';
                } else {
                    switchBtn.textContent = 'ã‚¢ ç‰‡å‡å';
                    switchBtn.style.background = '#fff3e0';
                    switchBtn.style.color = '#ff6600';
                }
                switchBtn.dataset.type = this.currentKanaType;
                this.updateCandidates();
                console.log('åˆ‡æ¢å‡åç±»å‹åˆ°:', this.currentKanaType);
            }
            
            // æ›´æ–°å‡åå€™é€‰
            updateCandidates() {
                const candidatesDiv = document.getElementById('kanaCandidates');
                candidatesDiv.innerHTML = '';
                
                if (this.currentRomaji.length === 0) {
                    candidatesDiv.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 15px;">è¾“å…¥ç½—é©¬éŸ³å­—æ¯ï¼Œâ†‘â†“é€‰æ‹©å‡åï¼ŒTab/Enterç¡®è®¤ï¼Œç‚¹å‡»æŒ‰é’®æäº¤<br><small>ğŸ’¡ åŒå†™è¾…éŸ³è¾“å…¥ä¿ƒéŸ³ï¼škkâ†’ã£, ttâ†’ã£, ssâ†’ã£</small></div>';
                    this.selectedCandidateIndex = 0;
                    return;
                }
                
                const possibilities = this.romajiConverter.getPossibleKana(this.currentRomaji, this.currentKanaType);
                
                if (possibilities.length === 0) {
                    candidatesDiv.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 15px;">æ²¡æœ‰åŒ¹é…çš„å‡å</div>';
                    this.selectedCandidateIndex = 0;
                    return;
                }
                
                // ç¡®ä¿é€‰æ‹©ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                if (this.selectedCandidateIndex >= possibilities.length) {
                    this.selectedCandidateIndex = 0;
                } else if (this.selectedCandidateIndex < 0) {
                    this.selectedCandidateIndex = possibilities.length - 1;
                }
                
                possibilities.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'kana-option';
                    
                    // é«˜äº®å½“å‰é€‰æ‹©çš„å€™é€‰
                    if (index === this.selectedCandidateIndex) {
                        optionDiv.classList.add('selected');
                    }
                    
                    // ä¸ºå½“å‰é€‰æ‹©çš„é€‰é¡¹æ·»åŠ å¿«æ·é”®æç¤º
                    let shortcutHint = '';
                    if (index === this.selectedCandidateIndex) {
                        shortcutHint = ' <span style="color: #28a745; font-size: 0.7rem;">[Tab/Enterç¡®è®¤]</span>';
                    }
                    
                    // å¤„ç†ä¿ƒéŸ³æ˜¾ç¤º
                    let displayRomaji = option.displayRomaji || option.romaji;
                    let specialHint = '';
                    
                    if (option.isSokuon) {
                        specialHint = ' <span style="color: #ff6600; font-size: 0.7rem;">[ä¿ƒéŸ³]</span>';
                    } else if (option.isSokuonCombo) {
                        specialHint = ' <span style="color: #ff6600; font-size: 0.7rem;">[ä¿ƒéŸ³ç»„åˆ]</span>';
                    }
                    
                    optionDiv.innerHTML = `
                        <span class="kana-romaji">${displayRomaji}${shortcutHint}${specialHint}</span>
                        <span class="kana-text">${option.kana}</span>
                    `;
                    
                    optionDiv.addEventListener('click', () => {
                        this.selectedCandidateIndex = index;
                        this.selectKana(option.kana);
                    });
                    
                    candidatesDiv.appendChild(optionDiv);
                });
            }
            
            // é€‰æ‹©å‡åï¼ˆè™šæ‹Ÿé”®ç›˜ç‚¹å‡»ï¼‰
            selectKana(kana) {
                this.selectKanaFromKeyboard(kana);
            }
            
            // æ›´æ–°å½“å‰è¾“å…¥æ˜¾ç¤º
            updateCurrentInput() {
                const romajiSpan = document.getElementById('inputRomaji');
                romajiSpan.textContent = this.currentRomaji || '(ç©º)';
            }
            
            // å¤„ç†ç‰©ç†é”®ç›˜è¾“å…¥
            handlePhysicalInput(fullValue) {
                // åˆ†æè¾“å…¥å†…å®¹ï¼Œæå–ç½—é©¬éŸ³éƒ¨åˆ†
                const parts = this.analyzeInput(fullValue);
                this.currentRomaji = parts.currentRomaji;
                
                this.updateCandidates();
                this.updateCurrentInput();
            }
            
            // åˆ†æè¾“å…¥å†…å®¹ï¼Œåˆ†ç¦»å·²è½¬æ¢çš„å‡åå’Œå½“å‰çš„ç½—é©¬éŸ³
            analyzeInput(fullValue) {
                let convertedKana = '';
                let currentRomaji = '';
                let tempRomaji = '';
                
                for (let i = 0; i < fullValue.length; i++) {
                    const char = fullValue[i];
                    
                    // å¦‚æœæ˜¯å‡åå­—ç¬¦ï¼Œç›´æ¥æ·»åŠ åˆ°è½¬æ¢ç»“æœ
                    if (this.isKanaCharacter(char)) {
                        convertedKana += char;
                        tempRomaji = '';
                    } else if (/^[a-zA-Z]$/.test(char)) {
                        tempRomaji += char.toLowerCase();
                    }
                }
                
                currentRomaji = tempRomaji;
                
                return {
                    convertedKana,
                    currentRomaji
                };
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‡åå­—ç¬¦
            isKanaCharacter(char) {
                const code = char.charCodeAt(0);
                // å¹³å‡åèŒƒå›´: 0x3040-0x309F
                // ç‰‡å‡åèŒƒå›´: 0x30A0-0x30FF
                return (code >= 0x3040 && code <= 0x309F) || (code >= 0x30A0 && code <= 0x30FF);
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å‡åå€™é€‰
            hasValidCandidates() {
                if (this.currentRomaji.length === 0) return false;
                const possibilities = this.romajiConverter.getPossibleKana(this.currentRomaji, this.currentKanaType);
                return possibilities.length > 0;
            }
            
            // ç§»åŠ¨å€™é€‰é€‰æ‹©
            moveCandidateSelection(direction) {
                if (!this.hasValidCandidates()) return;
                
                const possibilities = this.romajiConverter.getPossibleKana(this.currentRomaji, this.currentKanaType);
                this.selectedCandidateIndex += direction;
                
                // å¾ªç¯é€‰æ‹©
                if (this.selectedCandidateIndex >= possibilities.length) {
                    this.selectedCandidateIndex = 0;
                } else if (this.selectedCandidateIndex < 0) {
                    this.selectedCandidateIndex = possibilities.length - 1;
                }
                
                this.updateCandidates();
            }
            
            // é€‰æ‹©å½“å‰é«˜äº®çš„å€™é€‰
            selectCurrentCandidate() {
                if (!this.hasValidCandidates()) return;
                
                const possibilities = this.romajiConverter.getPossibleKana(this.currentRomaji, this.currentKanaType);
                if (this.selectedCandidateIndex < possibilities.length) {
                    const selectedOption = possibilities[this.selectedCandidateIndex];
                    this.selectKanaFromKeyboard(selectedOption.kana);
                }
            }
            
            // é€‰æ‹©ç¬¬ä¸€ä¸ªå‡åå€™é€‰
            selectFirstCandidate() {
                const firstOption = document.querySelector('.kana-option');
                if (firstOption) {
                    const kanaText = firstOption.querySelector('.kana-text').textContent;
                    this.selectKanaFromKeyboard(kanaText);
                }
            }
            
            // é€‰æ‹©ä¸‹ä¸€ä¸ªå€™é€‰ï¼ˆTabé”®åŠŸèƒ½ï¼‰
            selectNextCandidate() {
                const options = document.querySelectorAll('.kana-option');
                if (options.length > 1) {
                    const secondOption = options[1];
                    const kanaText = secondOption.querySelector('.kana-text').textContent;
                    this.selectKanaFromKeyboard(kanaText);
                }
            }
            
            // é€šè¿‡é”®ç›˜é€‰æ‹©å‡å
            selectKanaFromKeyboard(kana) {
                const input = document.getElementById('answerInput');
                const currentValue = input.value;
                
                // ç§»é™¤å½“å‰çš„ç½—é©¬éŸ³éƒ¨åˆ†ï¼Œæ·»åŠ é€‰æ‹©çš„å‡å
                const newValue = currentValue.substring(0, currentValue.length - this.currentRomaji.length) + kana;
                input.value = newValue;
                
                this.currentRomaji = '';
                this.updateCandidates();
                this.updateCurrentInput();
                
                // å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
                input.setSelectionRange(input.value.length, input.value.length);
            }
            
            // æ¸…ç©ºå½“å‰ç½—é©¬éŸ³
            clearCurrentRomaji() {
                if (this.currentRomaji.length > 0) {
                    const input = document.getElementById('answerInput');
                    const currentValue = input.value;
                    input.value = currentValue.substring(0, currentValue.length - this.currentRomaji.length);
                    this.currentRomaji = '';
                    this.updateCandidates();
                    this.updateCurrentInput();
                }
            }
            
            bindEvents() {
                const input = document.getElementById('answerInput');
                
                // ç›‘å¬é”®ç›˜è¾“å…¥äº‹ä»¶
                input.addEventListener('input', (e) => {
                    this.handlePhysicalInput(e.target.value);
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        // Enteré”®ï¼šåªç”¨äºå‡åé€‰æ‹©ï¼Œä¸ç”¨äºæäº¤ç­”æ¡ˆ
                        e.preventDefault();
                        if (this.currentRomaji.length > 0 && this.hasValidCandidates()) {
                            // å¦‚æœæœ‰ç½—é©¬éŸ³è¾“å…¥ä¸”æœ‰æœ‰æ•ˆå€™é€‰ï¼ŒEnteré”®é€‰æ‹©å½“å‰é«˜äº®çš„å‡åå€™é€‰
                            this.selectCurrentCandidate();
                        }
                        // ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨ç‚¹å‡»æäº¤æŒ‰é’®æ¥æäº¤ç­”æ¡ˆ
                    } else if (e.key === 'Tab') {
                        // Tabé”®ï¼šé€‰æ‹©å½“å‰é«˜äº®çš„å‡åå€™é€‰
                        e.preventDefault();
                        if (this.currentRomaji.length > 0 && this.hasValidCandidates()) {
                            this.selectCurrentCandidate();
                        }
                    } else if (e.key === 'ArrowUp') {
                        // â†‘é”®ï¼šå‘ä¸Šé€‰æ‹©å€™é€‰
                        e.preventDefault();
                        if (this.currentRomaji.length > 0) {
                            this.moveCandidateSelection(-1);
                        }
                    } else if (e.key === 'ArrowDown') {
                        // â†“é”®ï¼šå‘ä¸‹é€‰æ‹©å€™é€‰
                        e.preventDefault();
                        if (this.currentRomaji.length > 0) {
                            this.moveCandidateSelection(1);
                        }
                    } else if (e.key === 'Escape') {
                        // Escé”®æ¸…ç©ºå½“å‰è¾“å…¥
                        this.clearCurrentRomaji();
                    }
                });
                
                input.focus();
            }
            
            showCurrentQuestion() {
                if (window.performanceMonitor) {
                    return window.performanceMonitor.measureOperation('showCurrentQuestion', () => {
                        return this._showCurrentQuestionInternal();
                    });
                } else {
                    return this._showCurrentQuestionInternal();
                }
            }
            
            _showCurrentQuestionInternal() {
                if (this.currentIndex >= this.words.length) {
                    this.showResult();
                    return;
                }
                
                const word = this.words[this.currentIndex];
                console.log('å½“å‰æ˜¾ç¤ºçš„å•è¯æ•°æ®:', word);
                
                this.currentWordData = word;
                this.currentAnswer = word.kana || word.word || '';
                
                console.log('è®¾ç½®çš„æ­£ç¡®ç­”æ¡ˆ:', this.currentAnswer);
                
                document.getElementById('questionMeaning').textContent = word.meaning || 'æ— å«ä¹‰';
                document.getElementById('questionInfo').textContent = 
                    `${word.lesson || 'æœªçŸ¥è¯¾ç¨‹'} Â· ${word.section || word.category || 'æœªåˆ†ç±»'} Â· ${word.wordType || ''} Â· ç¬¬${word.currentRepeat}/${word.totalRepeats}æ¬¡`;
                document.getElementById('repeatInfo').textContent = 
                    `èƒŒè¯µè¿›åº¦: ${word.currentRepeat}/${word.totalRepeats}`;
                document.getElementById('progressText').textContent = 
                    `é¢˜ç›® ${this.currentIndex + 1} / ${this.words.length}`;
                document.getElementById('progressFill').style.width = 
                    `${((this.currentIndex) / this.words.length) * 100}%`;
                
                const input = document.getElementById('answerInput');
                input.value = '';
                input.className = 'answer-input';
                input.focus();
                
                // é‡ç½®è™šæ‹Ÿé”®ç›˜çŠ¶æ€
                this.currentRomaji = '';
                this.selectedCandidateIndex = 0;
                this.updateCandidates();
                this.updateCurrentInput();
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                this.resetButtons();
                
                // éšè—æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸï¼ˆä¸ºæ–°é—®é¢˜åšå‡†å¤‡ï¼‰
                const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
                if (correctAnswerDisplay) {
                    correctAnswerDisplay.classList.add('hidden');
                }
            }
            
            checkAnswer() {
                console.log('checkAnswer è¢«è°ƒç”¨ - æäº¤ç­”æ¡ˆé€»è¾‘');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–å®Œæˆ
                if (!this.currentWordData || !this.currentAnswer) {
                    console.log('æ•°æ®æœªåˆå§‹åŒ–å®Œæˆï¼Œå¿½ç•¥checkAnswerè°ƒç”¨');
                    return;
                }
                
                const input = document.getElementById('answerInput');
                const userAnswer = input.value.trim();
                
                console.log('ç”¨æˆ·è¾“å…¥:', userAnswer);
                
                // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¾“å…¥å†…å®¹
                if (!userAnswer) {
                    alert('è¯·è¾“å…¥ç­”æ¡ˆï¼');
                    return;
                }
                
                // ç¬¬äºŒæ­¥ï¼šåˆ¤æ–­ç­”æ¡ˆæ­£ç¡®æ€§
                if (validateAnswer(userAnswer, this.currentAnswer)) {
                    // ç”¨æˆ·è¾“å…¥æ­£ç¡®ï¼šç»¿è‰²æç¤ºï¼Œè‡ªåŠ¨è·³è½¬ä¸‹ä¸€é¢˜
                    this.correctCount++;
                    input.className = 'answer-input correct';
                    
                    console.log('å›ç­”æ­£ç¡®!');
                    
                    // æ›´æ–°åŸå§‹å•è¯æ•°æ®çš„èƒŒè¯µæ¬¡æ•°
                    const originalWord = this.originalWords[this.currentWordData.originalIndex];
                    if (originalWord && originalWord.repeatCount > 0) {
                        originalWord.repeatCount--;
                        console.log(`å•è¯"${originalWord.meaning}"èƒŒè¯µæ¬¡æ•°å‡1ï¼Œå‰©ä½™${originalWord.repeatCount}æ¬¡`);
                    }
                    
                    // ä»ç»ƒä¹ é˜Ÿåˆ—ä¸­ç§»é™¤ç›¸åŒå•è¯çš„æ‰€æœ‰å‰©ä½™å®ä¾‹
                    this.removeRemainingInstancesOfCurrentWord();
                    
                    // è‡ªåŠ¨è·³è½¬ä¸‹ä¸€é¢˜
                    setTimeout(() => this.nextQuestion(), 1000);
                } else {
                    // ç”¨æˆ·è¾“å…¥ä¸æ­£ç¡®ï¼šçº¢è‰²æç¤ºï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆï¼Œä¸‹ä¸€é¢˜æŒ‰é’®å‡ºç°ï¼Œç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€é¢˜ç”¨äºæ‰‹åŠ¨è·³è½¬
                    this.wrongCount++;
                    input.className = 'answer-input incorrect';
                    console.log(`å›ç­”é”™è¯¯: ç”¨æˆ·ç­”æ¡ˆ"${userAnswer}" != æ­£ç¡®ç­”æ¡ˆ"${this.currentAnswer}"`);
                    
                    // è®°å½•é”™è¯¯åˆ°é”™é¢˜è·Ÿè¸ªå™¨
                    if (window.mistakeTracker && this.currentWordData) {
                        window.mistakeTracker.recordMistake(this.currentWordData, 'wrong');
                    }
                    
                    // æ˜¾ç¤ºç»¿è‰²æ­£ç¡®ç­”æ¡ˆåŒºåŸŸï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                    // åŒæ—¶æ˜¾ç¤ºå‡åå’Œæ±‰å­—ï¼Œä¸æ˜¾ç¤ºæç¤ºæ–‡å­—
                    const kanjiText = this.currentWordData.kanji || '';
                    const kanaElement = document.getElementById('correctAnswerKana');
                    const kanjiElement = document.getElementById('correctAnswerKanji');
                    const displayElement = document.getElementById('correctAnswerDisplay');
                    
                    if (kanaElement && kanjiElement && displayElement) {
                        kanaElement.textContent = this.currentAnswer; // å‡å
                        kanjiElement.textContent = kanjiText; // æ±‰å­—å•è¯
                        displayElement.classList.remove('hidden');
                    } else {
                        console.error('æ‰¾ä¸åˆ°æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå…ƒç´ ');
                    }
                    
                    // æ›´æ¢æŒ‰é’®ä¸º"ä¸‹ä¸€é¢˜"
                    this.updateButtonsForIncorrect();
                    
                    // æ˜¾ç¤ºçº¢è‰²é”™è¯¯ä¿¡æ¯å¼¹çª—
                    this.showErrorDisplay(userAnswer);
                }
            }
            
            // ç§»é™¤å½“å‰å•è¯åœ¨é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‰©ä½™å®ä¾‹ï¼ˆç”¨äºæ­£ç¡®å›ç­”åï¼‰
            removeRemainingInstancesOfCurrentWord() {
                if (window.performanceMonitor) {
                    return window.performanceMonitor.measureOperation('removeRemainingInstances', () => {
                        return this._removeRemainingInstancesInternal();
                    });
                } else {
                    return this._removeRemainingInstancesInternal();
                }
            }
            
            _removeRemainingInstancesInternal() {
                const currentWordKey = `${this.currentWordData.lesson}|${this.currentWordData.kana}|${this.currentWordData.kanji}`;
                const remainingWords = [];
                
                for (let i = this.currentIndex + 1; i < this.words.length; i++) {
                    const word = this.words[i];
                    const wordKey = `${word.lesson}|${word.kana}|${word.kanji}`;
                    if (wordKey !== currentWordKey) {
                        remainingWords.push(word);
                    }
                }
                
                // æ›´æ–°é˜Ÿåˆ—ï¼Œç§»é™¤ç›¸åŒå•è¯çš„åç»­å®ä¾‹
                this.words = this.words.slice(0, this.currentIndex + 1).concat(remainingWords);
                console.log(`ç§»é™¤å•è¯"${this.currentWordData.meaning}"çš„å‰©ä½™ç»ƒä¹ å®ä¾‹ï¼Œé˜Ÿåˆ—å‰©ä½™${this.words.length - this.currentIndex - 1}é¢˜`);
            }
            
            // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆï¼ˆåŒ…æ‹¬å‡åå†…å®¹ä»¥åŠå•è¯å†…å®¹ï¼‰
            showCorrectAnswerDisplay() {
                console.log('æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ');
                
                // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆåŒºåŸŸï¼ˆå‡åå’Œæ±‰å­—ï¼‰
                const kanaElement = document.getElementById('correctAnswerKana');
                const kanjiElement = document.getElementById('correctAnswerKanji');
                const displayElement = document.getElementById('correctAnswerDisplay');
                
                if (kanaElement && kanjiElement && displayElement) {
                    kanaElement.textContent = this.currentAnswer;
                    const kanjiText = this.currentWordData.kanji || '';
                    kanjiElement.textContent = kanjiText;
                    displayElement.classList.remove('hidden');
                } else {
                    console.error('æ‰¾ä¸åˆ°æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå…ƒç´ ');
                }
                
                // é‡ç½®è™šæ‹Ÿé”®ç›˜çŠ¶æ€
                this.currentRomaji = '';
                this.updateCandidates();
                this.updateCurrentInput();
                
                console.log('æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸå·²æ˜¾ç¤º');
            }
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¼¹çª—
            showErrorDisplay(userAnswer) {
                const yourAnswerElement = document.getElementById('yourAnswer');
                const correctAnswerElement = document.getElementById('errorDisplay').querySelector('#correctAnswerDisplay');
                const kanjiDisplayElement = document.getElementById('kanjiDisplay');
                const errorDisplayElement = document.getElementById('errorDisplay');
                
                if (yourAnswerElement && correctAnswerElement && kanjiDisplayElement && errorDisplayElement) {
                    yourAnswerElement.textContent = userAnswer;
                    correctAnswerElement.textContent = this.currentAnswer;
                    kanjiDisplayElement.textContent = this.currentWordData.kanji || 'æ— æ±‰å­—';
                    errorDisplayElement.classList.remove('hidden');
                } else {
                    console.error('æ‰¾ä¸åˆ°é”™è¯¯æ˜¾ç¤ºå…ƒç´ ');
                }
                
                // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ŒæŒ‰ Enter æˆ– Escape é”®ç»§ç»­ä¸‹ä¸€é¢˜
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        document.removeEventListener('keydown', handleKeyPress);
                        this.continueToNext();
                    }
                };
                document.addEventListener('keydown', handleKeyPress);
            }
            
            // ç»§ç»­ä¸‹ä¸€é¢˜
            continueToNext() {
                console.log('ç»§ç»­ä¸‹ä¸€é¢˜è¢«è°ƒç”¨');
                const errorDisplay = document.getElementById('errorDisplay');
                if (errorDisplay) {
                    errorDisplay.classList.add('hidden');
                }
                
                // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        document.removeEventListener('keydown', handleKeyPress);
                    }
                };
                document.removeEventListener('keydown', handleKeyPress);
                
                // éšè—ç»¿è‰²æ­£ç¡®ç­”æ¡ˆåŒºåŸŸ
                const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
                if (correctAnswerDisplay) {
                    correctAnswerDisplay.classList.add('hidden');
                }
                
                this.nextQuestion();
            }
            
            showAnswer() {
                console.log('showAnswer è¢«è°ƒç”¨ - æˆ‘ä¸ä¼šåŠŸèƒ½');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–å®Œæˆ
                if (!this.currentWordData || !this.currentAnswer) {
                    console.log('æ•°æ®æœªåˆå§‹åŒ–å®Œæˆï¼Œå¿½ç•¥showAnswerè°ƒç”¨');
                    return;
                }
                
                // "æˆ‘ä¸ä¼š"æŒ‰é’®ç‚¹å‡»ï¼šæŒ‰ç…§ç”¨æˆ·é€»è¾‘ï¼Œè¿™ç­‰åŒäº"ç”¨æˆ·è¾“å…¥ä¸æ­£ç¡®"
                // å¢åŠ "æˆ‘ä¸ä¼š"è®¡æ•°
                this.dontKnowCount++;
                console.log('dontKnowCountå¢åŠ åˆ°:', this.dontKnowCount);
                
                // è®°å½•é”™è¯¯åˆ°é”™é¢˜è·Ÿè¸ªå™¨
                if (window.mistakeTracker && this.currentWordData) {
                    window.mistakeTracker.recordMistake(this.currentWordData, 'dont_know');
                }
                
                // æ˜¾ç¤ºç»¿è‰²æ­£ç¡®ç­”æ¡ˆåŒºåŸŸï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                // åŒæ—¶æ˜¾ç¤ºå‡åå’Œæ±‰å­—ï¼Œä¸æ˜¾ç¤ºæç¤ºæ–‡å­—
                const kanjiText = this.currentWordData.kanji || '';
                const kanaElement = document.getElementById('correctAnswerKana');
                const kanjiElement = document.getElementById('correctAnswerKanji');
                const displayElement = document.getElementById('correctAnswerDisplay');
                
                if (kanaElement && kanjiElement && displayElement) {
                    kanaElement.textContent = this.currentAnswer; // å‡å
                    kanjiElement.textContent = kanjiText; // æ±‰å­—å•è¯
                    displayElement.classList.remove('hidden');
                } else {
                    console.error('æ‰¾ä¸åˆ°æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå…ƒç´ ');
                }
                
                // æ›´æ¢æŒ‰é’®ä¸º"ä¸‹ä¸€é¢˜"
                this.updateButtonsForIncorrect();
                
                // æŒ‰ç…§é€»è¾‘ï¼šç”¨æˆ·è¾“å…¥ä¸æ­£ç¡®||ç‚¹å‡»æˆ‘ä¸ä¼š -> çº¢è‰²æç¤ºï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆï¼Œä¸‹ä¸€é¢˜æŒ‰é’®å‡ºç°
                this.showErrorDisplay('æˆ‘ä¸ä¼š');
                
                console.log(`å•è¯"${this.currentWordData.meaning}"ä½¿ç”¨äº†"æˆ‘ä¸ä¼š"åŠŸèƒ½ï¼ŒèƒŒè¯µæ¬¡æ•°ä¿æŒä¸å˜ï¼Œéœ€è¦ç»§ç»­ç»ƒä¹ `);
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºä¸æ­£ç¡®çŠ¶æ€ï¼ˆé”™è¯¯æˆ–æˆ‘ä¸ä¼šï¼‰
            updateButtonsForIncorrect() {
                const buttonsDiv = document.querySelector('.buttons');
                buttonsDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="safeCall('nextQuestion')">ä¸‹ä¸€é¢˜</button>
                    <button class="btn btn-secondary" onclick="safeCall('skipQuestion')">è·³è¿‡</button>
                `;
                console.log('æŒ‰é’®å·²æ›´æ–°ä¸ºé”™è¯¯çŠ¶æ€ï¼šä¸‹ä¸€é¢˜ã€è·³è¿‡');
            }
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€ä¸ºæ­£å¸¸çŠ¶æ€
            resetButtons() {
                console.log('resetButtons è¢«è°ƒç”¨');
                const buttonsDiv = document.querySelector('.buttons');
                if (!buttonsDiv) {
                    console.error('æ‰¾ä¸åˆ° .buttons å…ƒç´ ');
                    return;
                }
                
                buttonsDiv.innerHTML = `
                    <button class="btn btn-primary" id="submitBtn" onclick="safeCall('checkAnswer')">æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="safeCall('showAnswer')">æˆ‘ä¸ä¼š</button>
                    <button class="btn btn-secondary" onclick="safeCall('skipQuestion')">è·³è¿‡</button>
                `;
                console.log('æŒ‰é’®å·²é‡ç½®ä¸ºæ­£å¸¸çŠ¶æ€ï¼ŒåŒ…å«"æˆ‘ä¸ä¼š"æŒ‰é’®');
                
                // éªŒè¯æŒ‰é’®æ˜¯å¦æ­£ç¡®æ·»åŠ 
                const dontKnowBtn = buttonsDiv.querySelector('button[onclick*="showAnswer"]');
                if (dontKnowBtn) {
                    console.log('"æˆ‘ä¸ä¼š"æŒ‰é’®å·²æ­£ç¡®æ·»åŠ ');
                } else {
                    console.error('"æˆ‘ä¸ä¼š"æŒ‰é’®æ·»åŠ å¤±è´¥');
                }
            }
            
            skipQuestion() {
                // è·³è¿‡é¢˜ç›®ï¼šèƒŒè¯µæ¬¡æ•°ä¸å˜
                this.skippedCount++;
                console.log(`å•è¯"${this.currentWordData.meaning}"è¢«è·³è¿‡ï¼ŒèƒŒè¯µæ¬¡æ•°ä¿æŒä¸å˜`);
                this.nextQuestion();
            }
            
            nextQuestion() {
                this.currentIndex++;
                this.showCurrentQuestion();
            }
            
            showResult() {
                document.getElementById('practiceScreen').classList.add('hidden');
                document.getElementById('resultScreen').classList.remove('hidden');
                
                const total = this.words.length;
                const accuracy = total > 0 ? Math.round((this.correctCount / total) * 100) : 0;
                
                // è®¡ç®—å‰©ä½™èƒŒè¯µæ¬¡æ•°
                const remainingRepeats = this.originalWords.reduce((sum, word) => sum + (word.repeatCount || 0), 0);
                
                document.getElementById('resultStats').innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${total}</div>
                        <div class="stat-label">æ€»é¢˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${this.correctCount}</div>
                        <div class="stat-label">æ­£ç¡®æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${this.wrongCount}</div>
                        <div class="stat-label">é”™è¯¯æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${this.skippedCount}</div>
                        <div class="stat-label">è·³è¿‡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${this.dontKnowCount}</div>
                        <div class="stat-label">æˆ‘ä¸ä¼š</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${accuracy}%</div>
                        <div class="stat-label">æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${remainingRepeats}</div>
                        <div class="stat-label">å‰©ä½™æ¬¡æ•°</div>
                    </div>
                `;
                
                // é‡ç½®æŒ‰é’®åŒºåŸŸï¼Œæ¸…é™¤ä¹‹å‰æ·»åŠ çš„æŒ‰é’®
                const buttonsDiv = document.querySelector('#resultScreen .buttons');
                buttonsDiv.innerHTML = `
                    <button class="btn btn-success" onclick="restartPractice()">é‡æ–°ç»ƒä¹ </button>
                    <button class="btn btn-primary" onclick="backToSelection()">è¿”å›é€‰æ‹©</button>
                `;
                
                // å¦‚æœè¿˜æœ‰å‰©ä½™èƒŒè¯µæ¬¡æ•°ï¼Œæ·»åŠ ç»§ç»­ç»ƒä¹ æŒ‰é’®
                if (remainingRepeats > 0) {
                    const continueBtn = document.createElement('button');
                    continueBtn.className = 'btn btn-primary';
                    continueBtn.textContent = `ç»§ç»­ç»ƒä¹  (å‰©ä½™${remainingRepeats}æ¬¡)`;
                    continueBtn.onclick = () => this.continueWithRemaining();
                    
                    buttonsDiv.insertBefore(continueBtn, buttonsDiv.firstChild);
                }
            }
            
            // ç»§ç»­ç»ƒä¹ å‰©ä½™çš„èƒŒè¯µæ¬¡æ•°
            continueWithRemaining() {
                // é‡æ–°åˆ›å»ºç»ƒä¹ é˜Ÿåˆ—ï¼ŒåªåŒ…å«å‰©ä½™æ¬¡æ•°å¤§äº0çš„å•è¯
                const remainingWords = this.originalWords.filter(word => (word.repeatCount || 0) > 0);
                if (remainingWords.length === 0) {
                    alert('æ²¡æœ‰å‰©ä½™çš„å•è¯éœ€è¦ç»ƒä¹ ï¼');
                    return;
                }
                
                // ä¿å­˜å‰©ä½™å•è¯åˆ°sessionStorageå¹¶é‡æ–°å¼€å§‹
                sessionStorage.setItem('selectedWords', JSON.stringify(remainingWords));
                this.originalWords = remainingWords;
                this.currentIndex = 0;
                this.correctCount = 0;
                this.wrongCount = 0;
                this.skippedCount = 0;
                this.dontKnowCount = 0;
                
                this.createPracticeQueue();
                document.getElementById('resultScreen').classList.add('hidden');
                document.getElementById('practiceScreen').classList.remove('hidden');
                this.showCurrentQuestion();
            }
            
            restartPractice() {
                // é‡æ–°å¼€å§‹ç»ƒä¹ ï¼Œæ¢å¤æ‰€æœ‰åŸå§‹èƒŒè¯µæ¬¡æ•°
                const originalData = sessionStorage.getItem('selectedWords');
                if (originalData) {
                    // æ¢å¤åŸå§‹æ•°æ®
                    this.originalWords = JSON.parse(originalData);
                    this.currentIndex = 0;
                    this.correctCount = 0;
                    this.wrongCount = 0;
                    this.skippedCount = 0;
                    this.dontKnowCount = 0;
                    
                    this.createPracticeQueue();
                    document.getElementById('resultScreen').classList.add('hidden');
                    document.getElementById('practiceScreen').classList.remove('hidden');
                    this.showCurrentQuestion();
                }
            }
            
            backToSelection() {
                window.location.href = 'word-typing.html';
            }
        }
        
        // å…¨å±€å‡½æ•°
        let practice;
        
        // å®‰å…¨è°ƒç”¨å‡½æ•°ï¼Œç¡®ä¿practiceå¯¹è±¡å·²åˆå§‹åŒ–
        window.safeCall = (methodName) => {
            console.log(`safeCall è°ƒç”¨æ–¹æ³•: ${methodName}`);
            if (!practice) {
                console.error('practiceå¯¹è±¡æœªåˆå§‹åŒ–');
                alert('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            if (typeof practice[methodName] !== 'function') {
                console.error(`æ–¹æ³• ${methodName} ä¸å­˜åœ¨`);
                return;
            }
            try {
                practice[methodName]();
            } catch (error) {
                console.error(`è°ƒç”¨ ${methodName} æ—¶å‡ºé”™:`, error);
                alert(`æ“ä½œå¤±è´¥: ${error.message}`);
            }
        };
        
        window.checkAnswer = () => {
            if (practice && typeof practice.checkAnswer === 'function') {
                practice.checkAnswer();
            } else {
                console.error('ç»ƒä¹ æ¨¡å—æœªæ­£ç¡®åˆå§‹åŒ–');
            }
        };
        window.showAnswer = () => {
            if (practice && typeof practice.showAnswer === 'function') {
                practice.showAnswer();
            }
        };
        window.nextQuestion = () => {
            if (practice && typeof practice.nextQuestion === 'function') {
                practice.nextQuestion();
            }
        };
        window.skipQuestion = () => {
            if (practice && typeof practice.skipQuestion === 'function') {
                practice.skipQuestion();
            }
        };
        window.restartPractice = () => {
            if (practice && typeof practice.restartPractice === 'function') {
                practice.restartPractice();
            }
        };
        window.backToSelection = () => {
            if (practice && typeof practice.backToSelection === 'function') {
                practice.backToSelection();
            } else {
                window.location.href = 'word-typing.html';
            }
        };
        window.continueToNext = () => {
            if (practice && typeof practice.continueToNext === 'function') {
                practice.continueToNext();
            }
        };
        window.restartPractice = () => {
            if (practice && typeof practice.restartPractice === 'function') {
                practice.restartPractice();
            }
        };
        window.backToSelection = () => {
            if (practice && typeof practice.backToSelection === 'function') {
                practice.backToSelection();
            }
        };
        window.forceExit = () => {
            // å¼ºåˆ¶é€€å‡ºå‡½æ•°ï¼Œæ¸…ç†æ‰€æœ‰çŠ¶æ€
            const errorDisplay = document.getElementById('errorDisplay');
            if (errorDisplay) {
                errorDisplay.classList.add('hidden');
            }
            window.location.href = 'word-typing.html';
        };
        window.exitPractice = () => {
            if (confirm('ç¡®å®šè¦é€€å‡ºç»ƒä¹ å—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
                if (practice && typeof practice.backToSelection === 'function') {
                    practice.backToSelection();
                }
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMå†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç»ƒä¹ æ¨¡å—');
            
            // å¼ºåˆ¶ç¡®ä¿é”™è¯¯ç•Œé¢éšè—
            const errorDisplay = document.getElementById('errorDisplay');
            if (errorDisplay) {
                errorDisplay.classList.add('hidden');
                errorDisplay.style.display = 'none';
                console.log('å¼ºåˆ¶éšè—é”™è¯¯æ˜¾ç¤ºç•Œé¢');
            }
            
            try {
                practice = new WordPractice();
                console.log('ç»ƒä¹ æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('ç»ƒä¹ æ¨¡å—åˆå§‹åŒ–å¤±è´¥:', error);
                alert('ç»ƒä¹ æ¨¡å—åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });
    </script>
</body>
</html>
